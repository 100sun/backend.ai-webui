module.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=3)}([function(e,t){e.exports=require("log")},function(e,t,n){let r;const s=n(7),i=n(8),o=n(0);e.exports=r=class extends n(13).EventEmitter{constructor(){super(),this.tcpServer=s.createServer()}close(){this.tcpServer.close()}verbose(){return this.on("tunnel",(e,t)=>(o("Websocket tunnel established"),t.on("close",()=>o("Tunnel closed")))),this.on("connectHttpFailed",e=>o(`HTTP connect error: ${e.toString()}`)),this.on("connectFailed",e=>o(`WS connect error: ${e.toString()}`))}start(e,t,r,s,i){let c,a;return this.wsHostUrl=t,"number"==typeof e?a=e:([c,a]=Array.from(e.split(":")),/^\d+$/.test(c)&&(a=c,c=null),a=parseInt(a)),null==c&&(c="127.0.0.1"),this.tcpServer.listen(a,c,i),this.tcpServer.on("connection",e=>{const t=(e,t)=>(n(14)(e,t),this.emit("tunnel",e,t));return this._wsConnect(this.wsHostUrl,r,s,(n,r)=>{if(!n)return t(r,e);this.emit("connectFailed",n),o("FAIL")})})}_wsConnect(e,t,r,s){let o=r();const c=(()=>new(n(12).client))();return c.connect(e,void 0,void 0,o,{agent:null}),c.on("connectFailed",e=>s(e)),c.on("connect",e=>{const t=new i(e);return s(null,t)})}}},function(e,t,n){var r=n(17),s=r.Headers,i=n(18);class o{constructor(e,t,n){if(this._apiVersionMajor="v3",this._apiVersion="v3.20170615",this._hashType="sha256",null==e)throw"You must set accessKey! (either as argument or environment variable)";if(null==t)throw"You must set secretKey! (either as argument or environment variable)";null==n&&(n="https://api.backend.ai"),this._endpoint=n,this._endpointHost=n.replace(/^[^:]+:\/\//,""),this._accessKey=e,this._secretKey=t}get accessKey(){return this._accessKey}get secretKey(){return this._secretKey}get endpoint(){return this._endpoint}get endpointHost(){return this._endpointHost}get apiVersion(){return this._apiVersion}get apiVersionMajor(){return this._apiVersionMajor}get hashType(){return this._hashType}static createFromEnv(){return new this(process.env.BACKEND_ACCESS_KEY,process.env.BACKEND_SECRET_KEY,process.env.BACKEND_ENDPOINT)}}class c{constructor(e,t){this.code=null,this.kernelId=null,this.kernelType=null,this.clientVersion="0.4.0",this.agentSignature=t,this._config=void 0===e?o.createFromEnv():e}async _wrapWithPromise(e){let t,n,s,i=c.ERR_REQUEST;console.log(e.method);try{"GET"==e.method&&(e.body=void 0),n=await r(e.uri,e),i=c.ERR_RESPONSE;let o=n.headers.get("Content-Type");if(s=o.startsWith("application/json")||o.startsWith("application/problem+json")?await n.json():o.startsWith("text/")?await n.text():void 0===n.blob?await n.buffer():await n.blob(),i=c.ERR_SERVER,!n.ok)throw s}catch(e){switch(i){case c.ERR_REQUEST:t=`sending request has failed: ${e}`;break;case c.ERR_RESPONSE:t=`reading response has failed: ${e}`;break;case c.ERR_SERVER:t="server responded failure: "+`${n.status} ${n.statusText} - ${s.title}`}throw{type:i,message:t}}return s}getServerVersion(){let e=this.newPublicRequest("GET","",null,"");return this._wrapWithPromise(e)}createIfNotExists(e,t){void 0===t&&(t=this.generateSessionId());let n={lang:e,clientSessionToken:t},r=this.newSignedRequest("POST","/kernel/create",n);return this._wrapWithPromise(r)}getInformation(e){let t=this.newSignedRequest("GET",`/kernel/${e}`,null);return this._wrapWithPromise(t)}destroy(e){let t=this.newSignedRequest("DELETE",`/kernel/${e}`,null);return this._wrapWithPromise(t)}restart(e){let t=this.newSignedRequest("PATCH",`/kernel/${e}`,null);return this._wrapWithPromise(t)}execute(e,t,n,r,s){let i={mode:n,code:r,runId:t,options:s},o=this.newSignedRequest("POST",`/kernel/${e}`,i);return this._wrapWithPromise(o)}createKernel(e){return this.createIfNotExists(e)}destroyKernel(e){return this.destroy(e)}refreshKernel(e){return this.restart(e)}runCode(e,t,n,r){return this.execute(t,n,r,e,{})}mangleUserAgentSignature(){return this.clientVersion+(this.agentSignature?"; "+this.agentSignature:"")}gql(e,t){let n={query:e,variables:t},r=this.newSignedRequest("POST","/admin/graphql",n);return this._wrapWithPromise(r)}test_gql(){let e="query($ak:String, $status:String) {"+`  compute_sessions(access_key:$ak, status:$status) { ${["sess_id","lang","created_at","terminated_at","status","mem_slot","cpu_slot","gpu_slot","cpu_used","io_read_bytes","io_write_bytes"].join(" ")} }`+"}",t={status:"RUNNING",ak:this._config.accessKey};var n=this.gql(e,t);console.log(n)}newSignedRequest(e,t,n){let r,i=new Date,o=this.getSignKey(this._config.secretKey,i);r=null==n?"":JSON.stringify(n);let c=this.getAuthenticationString(e,t,i.toISOString(),r),a=this.sign(o,"binary",c,"hex");return{method:e,headers:new s({"Content-Type":"application/json","Content-Length":Buffer.byteLength(r),"User-Agent":`Backend.AI Client for Javascript ${this.mangleUserAgentSignature()}`,"X-BackendAI-Version":this._config.apiVersion,"X-BackendAI-Date":i.toISOString(),Authorization:`BackendAI signMethod=HMAC-SHA256, credential=${this._config.accessKey}:${a}`}),cache:"default",body:r,uri:this._config.endpoint+t}}newUnsignedRequest(e,t,n){return this.newPublicRequest(e,t,n,this._config.apiVersionMajor)}newPublicRequest(e,t,n,r){let i=new Date;return{method:e,headers:new s({"Content-Type":"application/json","User-Agent":`Backend.AI Client for Javascript ${this.mangleUserAgentSignature()}`,"X-BackendAI-Version":this._config.apiVersion,"X-BackendAI-Date":i.toISOString()}),mode:"cors",cache:"default",uri:this._config.endpoint+t}}getAuthenticationString(e,t,n,r){let s=i.createHash(this._config.hashType).update(r).digest("hex");return e+"\n"+t+"\n"+n+"\nhost:"+this._config.endpointHost+"\ncontent-type:application/json\nx-backendai-version:"+this._config.apiVersion+"\n"+s}getCurrentDate(e){return`0000${e.getUTCFullYear()}`.slice(-4)+`0${e.getUTCMonth()+1}`.slice(-2)+`0${e.getUTCDate()}`.slice(-2)}sign(e,t,n,r){let s=new Buffer(e,t),o=i.createHmac(this._config.hashType,s);return o.update(n,"utf8"),o.digest(r)}getSignKey(e,t){let n=this.sign(e,"utf8",this.getCurrentDate(t),"binary");return this.sign(n,"binary",this._config.endpointHost,"binary")}generateSessionId(){for(var e="backend-ai-SDK-js-",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<8;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}}Object.defineProperty(c,"ERR_SERVER",{value:0,writable:!1,enumerable:!0,configurable:!1}),Object.defineProperty(c,"ERR_RESPONSE",{value:1,writable:!1,enumerable:!0,configurable:!1}),Object.defineProperty(c,"ERR_REQUEST",{value:2,writable:!1,enumerable:!0,configurable:!1});const a={Client:c,ClientConfig:o};e.exports.backend=a,e.exports.Client=c,e.exports.ClientConfig=o,e.exports.BackendAIClient=c,e.exports.BackendAIClientConfig=o},function(e,t,n){e.exports=n(4)},function(e,t,n){const r=n(5),s=n(6),i=r(),o=(n(1),n(2)),c=n(19);e.exports=function(e){let t,a,u={},{getFreePorts:l}=n(20);i.use(r.json()),i.use(s()),i.put("/conf",function(e,n){t=new o.backend.ClientConfig(e.body.access_key,e.body.secret_key,e.body.endpoint),a=new o.backend.Client(t),n.send({})}),i.get("/",function(e,n){if(null==t)return void n.send({code:401});let r=[];for(var s in u)r.push(s);n.send(r)}),i.get("/proxy/:kernelId",function(e,n){null!=t?e.params.kernelId in u?n.send({code:200}):n.send({code:404}):n.send({code:401})}),i.get("/proxy/:kernelId/add",function(e,n){if(null==t)return void n.send({code:401});let r=e.params.kernelId;if(r in u){let e=u[r];n.send({code:200,proxy:e.host})}else{let e=new c(a._config);l(1,"localhost").then(t=>{e.start_proxy(r,"jupyter",t[0]),u[r]=e,n.send({code:200,proxy:e.host})})}}),i.get("/proxy/:kernelId/delete",function(e,n){if(null==t)return void n.send({code:401});let r=e.params.kernelId;r in u?(u[r].stop_proxy(),n.send({code:200}),delete u[r]):n.send({code:404})}),i.listen(e,()=>console.log(`Listening on port ${e}!`))}},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("net")},function(e,t,n){let r;const s=n(9);n(10),n(0),n(11);e.exports=r=class extends s.Duplex{constructor(e){super(),this.ws=e,this._sig="ws",this._open=!0,this.ws.on("message",e=>{if(this._open)return this.push(e.binaryData)}),this.ws.on("close",()=>(this._open=!1,this.emit("close"))),this.ws.on("error",e=>this.emit("error",e))}end(){return super.end(),this.ws.close()}_read(){}_write(e,t,n){if(this._open)return this.ws.sendBytes(e,n)}}},function(e,t){e.exports=require("stream")},function(e,t){e.exports=require("assert")},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("websocket")},function(e,t){e.exports=require("events")},function(e,t,n){n(15);const r=n(0),s=n(16);let i=0;e.exports=function(e,t){let n;const o=i++,c=(e,t)=>r(`${o} ${(e=>e._sig||"tcp")(e)} ${t}`);n=s.isDebug?c:function(){};const a=function(){if(!this._stop)return n(this,"stop"),this._stop=!0,this.end()};e.stop=a,t.stop=a,e.on("error",function(n){return c(e,n),e.stop(),t.stop()}),t.on("error",function(n){return c(t,n),t.stop(),e.stop()});!function(){e.on("close",function(){return n(e,"close"),t.stop()}),t.on("close",function(){return n(t,"close"),e.stop()});e.pipe(t,{end:!0}).pipe(e,{end:!0})}()}},function(e,t){e.exports=require("underscore")},function(e,t,n){const r=n(0);e.exports={isDebug:process.env.NODE_DEBUG&&/wstunnel/.test(process.env.NODE_DEBUG)},e.exports.isDebug?e.exports.log=(e=>r(e)):e.exports.log=function(){}},function(e,t){e.exports=require("node-fetch")},function(e,t){e.exports=require("crypto")},function(e,t,n){const r=n(1),s=n(2);e.exports=proxy=class extends s.backend.Client{get_header(e){let t=new Date;console.log(t);let n=this.getSignKey(this._config.secretKey,t),r=this.getAuthenticationString("GET",e,t.toISOString(),""),s=this.sign(n,"binary",r,"hex");return{"Content-Type":"application/json","User-Agent":`Backend.AI Client for Javascript ${this.mangleUserAgentSignature()}`,"X-BackendAI-Version":this._config.apiVersion,"X-BackendAI-Date":t.toISOString(),Authorization:`BackendAI signMethod=HMAC-SHA256, credential=${this._config.accessKey}:${s}`}}start_proxy(e,t,n){this.port=n,this.host="localhost:"+n;let s="/stream/kernel/"+e+"/httpproxy?app="+t,i=this._config.endpoint+s;i=i.replace(/^http/,"ws");this.c=new r,this.c.verbose(),this.c.start(this.host,i,void 0,()=>this.get_header(s))}stop_proxy(){console.log("closing"),this.c.close()}}},function(e,t){e.exports=require("node-port-check")}]);